<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Dashboard - Bookify Hotel</title>
  <link href="css/bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="css/override.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Bookify<span class="gold-logo">Hotel</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="rooms.html">Rooms</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        </ul>
        <div id="navButtons" class="d-none d-lg-flex ms-lg-3 gap-2">
          <!-- Will be updated by JavaScript -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Welcome Section -->
  <section class="py-5 bg-light">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0 reveal">
            <div class="card-body p-4">
              <h1 class="fw-bold mb-2">üëã Welcome back, <span id="userName">User</span>!</h1>
              <p class="text-muted mb-0">Here's an overview of your bookings and account activity</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats Overview -->
  <section class="py-4">
    <div class="container">
      <h4 class="mb-3">Your Statistics</h4>
      <div class="row g-3" id="statsContainer">
        <div class="col-md-3 col-sm-6">
          <div class="card border-0 shadow-sm h-100 reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Total Bookings</h6>
                  <h3 class="mb-0" id="totalBookings">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h3>
                </div>
                <i class="bi bi-calendar-check text-primary" style="font-size: 2.5rem; opacity: 0.3;"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card border-0 shadow-sm h-100 reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Active Bookings</h6>
                  <h3 class="mb-0" id="activeBookings">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h3>
                </div>
                <i class="bi bi-clock-history text-success" style="font-size: 2.5rem; opacity: 0.3;"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card border-0 shadow-sm h-100 reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Total Spent</h6>
                  <h3 class="mb-0" id="totalSpent">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h3>
                </div>
                <i class="bi bi-cash-coin text-warning" style="font-size: 2.5rem; opacity: 0.3;"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card border-0 shadow-sm h-100 reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Upcoming</h6>
                  <h3 class="mb-0" id="upcomingCheckIns">
                    <span class="spinner-border spinner-border-sm"></span>
                  </h3>
                </div>
                <i class="bi bi-arrow-right-circle text-info" style="font-size: 2.5rem; opacity: 0.3;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Upcoming Bookings -->
  <section class="py-4 bg-light">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-calendar-event"></i> Upcoming Bookings</h4>
      </div>
      <div id="upcomingBookings" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading upcoming bookings...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- All Bookings -->
  <section class="py-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-list-check"></i> All My Bookings</h4>
        <a href="rooms.html" class="btn btn-accent">
          <i class="bi bi-plus-circle"></i> Book a Room
        </a>
      </div>
      <div id="myBookings" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading bookings...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Spending Summary -->
  <section class="py-4 bg-light">
    <div class="container">
      <h4 class="mb-3"><i class="bi bi-graph-up"></i> Spending Summary</h4>
      <div id="spendingSummary" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading spending data...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer text-white py-4 mt-auto">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
      <div>¬© <span id="year"></span> Bookify Hotel</div>
      <div class="d-flex gap-3 fs-5">
        <a class="text-white-50 hover-white" href="#"><i class="bi bi-twitter-x"></i></a>
        <a class="text-white-50 hover-white" href="#"><i class="bi bi-facebook"></i></a>
        <a class="text-white-50 hover-white" href="#"><i class="bi bi-instagram"></i></a>
      </div>
    </div>
  </footer>

  <!-- Chat Widget -->
  <div id="chatbot-btn" class="chat-btn" aria-label="Open chat" title="Open chat">üí¨</div>
  <div id="chatbot-window" class="chatbot-widget" dir="rtl" role="dialog" aria-labelledby="chat-title" aria-hidden="true">
    <div class="chat-top">
      <div id="chat-title" class="chat-title">Hotel Chat Bot ü§ñ</div>
      <button id="chat-close" class="chat-close-btn" aria-label="Close chat">√ó</button>
    </div>
    <div class="chat-body" id="chat-body" aria-live="polite">
      <div class="bubble bot" id="chat-bubble">
        ÿ£ŸáŸÑÿßŸã! ÿßÿÆÿ™ÿßÿ± ÿ±ŸÇŸÖ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©:
        <span class="list-item">1Ô∏è‚É£ ŸÉŸÑ ÿßŸÑÿ∫ÿ±ŸÅ</span>
        <span class="list-item">2Ô∏è‚É£ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</span>
        <span class="list-item">3Ô∏è‚É£ ÿ¢ÿÆÿ± ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™</span>
        <span class="list-item">4Ô∏è‚É£ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÜŸàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ©</span>
      </div>
    </div>
    <div class="chat-bottom" id="chat-bottom">
      <button class="opt-btn" data-val="1" aria-label="ŸÉŸÑ ÿßŸÑÿ∫ÿ±ŸÅ">1Ô∏è‚É£ ŸÉŸÑ ÿßŸÑÿ∫ÿ±ŸÅ</button>
      <button class="opt-btn" data-val="2" aria-label="ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©">2Ô∏è‚É£ ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</button>
      <button class="opt-btn" data-val="3" aria-label="ÿ¢ÿÆÿ± ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™">3Ô∏è‚É£ ÿ¢ÿÆÿ± ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™</button>
      <button class="opt-btn" data-val="4" aria-label="ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÜŸàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ©">4Ô∏è‚É£ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÜŸàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
    </div>
  </div>

  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/api-config.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/script.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Check authentication
    if (!Storage.isLoggedIn()) {
      window.location.href = 'login.html';
    }

    // Update navigation
    updateNavigation();

    // Set user name
    const user = Storage.getUser();
    if (user) {
      document.getElementById('userName').textContent = user.firstName;
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load stats
        const stats = await API.getUserStats();
        document.getElementById('totalBookings').textContent = stats.totalBookings;
        document.getElementById('activeBookings').textContent = stats.activeBookings;
        document.getElementById('totalSpent').textContent = formatCurrency(stats.totalSpent);
        document.getElementById('upcomingCheckIns').textContent = stats.upcomingCheckIns;

        // Load upcoming bookings
        const upcoming = await API.getUpcomingBookings();
        displayUpcomingBookings(upcoming);

        // Load all bookings
        const bookings = await API.getMyBookings();
        displayAllBookings(bookings);

        // Load spending summary
        const spending = await API.getSpendingSummary();
        displaySpendingSummary(spending);

        // Trigger reveal animation
        setTimeout(() => {
          document.querySelectorAll('.reveal').forEach(el => {
            el.classList.add('visible');
          });
        }, 100);

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard data', 'error');
      }
    }

    function displayUpcomingBookings(bookings) {
      const container = document.getElementById('upcomingBookings');
      
      if (!bookings || bookings.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="bi bi-info-circle"></i> No upcoming bookings.</div></div>';
        return;
      }

      container.innerHTML = bookings.map(booking => `
        <div class="col-md-6">
          <div class="card border-0 shadow-sm reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-2"><i class="bi bi-door-open"></i> Room #${booking.roomId}</h6>
                  <p class="mb-1 small"><i class="bi bi-calendar3"></i> ${formatDate(booking.checkIn)} - ${formatDate(booking.checkOut)}</p>
                  <p class="mb-0"><strong class="text-success">${formatCurrency(booking.totalPrice)}</strong></p>
                </div>
                <div class="text-end">
                  <span class="badge bg-success">${booking.status}</span>
                  <p class="small text-muted mt-2 mb-0">In ${booking.daysUntilCheckIn} days</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function displayAllBookings(bookings) {
      const container = document.getElementById('myBookings');
      
      if (!bookings || bookings.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> No bookings yet. <a href="rooms.html" class="alert-link">Book your first room!</a></div></div>';
        return;
      }

      container.innerHTML = bookings.map(booking => `
        <div class="col-md-6">
          <div class="card border-0 shadow-sm reveal">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-1">Room ${booking.roomNumber} - ${booking.hotelName}</h6>
                  <p class="small text-muted mb-1">Booking #${booking.id}</p>
                </div>
                <span class="badge ${getStatusBadge(booking.status)}">${booking.status}</span>
              </div>
              <p class="mb-1 small"><i class="bi bi-calendar3"></i> ${formatDate(booking.checkIn)} to ${formatDate(booking.checkOut)}</p>
              <p class="mb-2 small"><i class="bi bi-moon"></i> ${booking.numberOfNights} night(s) √ó ${formatCurrency(booking.pricePerNight)}</p>
              <div class="d-flex justify-content-between align-items-center">
                <strong class="text-primary">${formatCurrency(booking.totalPrice)}</strong>
                <div>
                  ${booking.isPaid ? '<small class="text-success me-2"><i class="bi bi-check-circle-fill"></i> Paid</small>' : 
                                   '<small class="text-warning me-2"><i class="bi bi-exclamation-circle-fill"></i> Pending</small>'}
                  ${booking.status === 'Pending' || booking.status === 'Confirmed' ? 
                    `<button class="btn btn-sm btn-outline-danger" onclick="cancelBooking(${booking.id})"><i class="bi bi-x-circle"></i> Cancel</button>` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function displaySpendingSummary(summary) {
      const container = document.getElementById('spendingSummary');
      
      if (!summary || summary.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="bi bi-info-circle"></i> No spending data available.</div></div>';
        return;
      }

      container.innerHTML = summary.map(item => `
        <div class="col-md-4">
          <div class="card border-0 shadow-sm reveal">
            <div class="card-body text-center">
              <h6 class="text-muted mb-2"><i class="bi bi-calendar-month"></i> ${item.monthName}</h6>
              <h4 class="mb-2 text-primary">${formatCurrency(item.totalSpent)}</h4>
              <p class="small text-muted mb-0">${item.bookingCount} booking(s)</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusBadge(status) {
      const badges = {
        'Pending': 'bg-warning',
        'Confirmed': 'bg-success',
        'Cancelled': 'bg-danger',
        'Completed': 'bg-secondary'
      };
      return badges[status] || 'bg-secondary';
    }

    async function cancelBooking(id) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;

      try {
        await API.cancelBooking(id);
        showToast('Booking cancelled successfully', 'success');
        loadDashboard();
      } catch (error) {
        showToast('Failed to cancel booking', 'error');
      }
    }

    // Load dashboard
    loadDashboard();
  </script>
</body>
</html>