<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>bookify Hotel | Booking</title>
    <link href="css/bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/override.css">
    <style>
      input[type="date"]:disabled {
        background-color: #f0f0f0;
        cursor: not-allowed;
      }
      .border-primary {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">Bookify<span class="gold-logo">Hotel</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="rooms.html">Rooms</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          </ul>
          <div id="navButtons" class="d-none d-lg-flex ms-lg-3 gap-2">
            <!-- Will be updated by JavaScript -->
          </div>
        </div>
      </div>
    </nav>

    <section class="py-5 bg-light">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-12 col-md-10 col-lg-8">
            <div class="card shadow-sm reveal booking-card">
              <div class="card-body p-4 p-md-5">
                <h1 class="h3 fw-bold mb-4 text-center">Book Your Stay</h1>
                
                <div id="bookingAlert"></div>

                <!-- Room Info -->
                <div class="room-info mb-4 p-3 border rounded bg-white" id="roomInfo">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <p class="mb-1"><strong>Room:</strong> <span id="roomType">-</span></p>
                      <p class="mb-0"><strong>Price:</strong> <span id="roomPrice">-</span>/night</p>
                    </div>
                    <span class="badge bg-success" id="roomStatus">Available</span>
                  </div>
                </div>

                <form id="bookingForm" novalidate>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="checkin" class="form-label">
                        <i class="bi bi-calendar-check"></i> Check-in Date
                      </label>
                      <input type="date" class="form-control" id="checkin" required>
                      <div class="form-text">Select your arrival date</div>
                    </div>
                    <div class="col-md-6">
                      <label for="checkout" class="form-label">
                        <i class="bi bi-calendar-x"></i> Check-out Date
                      </label>
                      <input type="date" class="form-control" id="checkout" required>
                      <div class="form-text">Must be after check-in date</div>
                    </div>

                    <div class="col-12">
                      <div class="alert alert-info">
                        <strong>Booking Summary:</strong>
                        <div id="bookingSummary" class="mt-2">
                          <div>Number of nights: <strong id="numNights">-</strong></div>
                          <div>Total price: <strong id="totalPrice">-</strong></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-accent btn-lg" id="bookNowBtn">
                      <span class="btn-text">Create Booking & Proceed to Payment</span>
                      <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Success Modal -->
    <div class="modal fade" id="bookingSuccessModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Booking Successful!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center">
              <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
              <h4 class="mt-3">Your booking has been confirmed!</h4>
              <p class="text-muted">Booking ID: <strong id="bookingId">-</strong></p>
              <p>Check your email for confirmation details.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <a href="user-dashboard.html" class="btn btn-primary">View My Bookings</a>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer text-white py-4 mt-auto">
      <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div>Â© <span id="year"></span> Bookify Hotel</div>
      </div>
    </footer>

    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/script.js"></script>
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      // Check if user is logged in
      if (!Storage.isLoggedIn()) {
        alert('Please login to book a room');
        window.location.href = 'login.html';
      }

      // Update navigation
      updateNavigation();

      // Get room ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('roomId');

      if (!roomId) {
        showError('bookingAlert', 'No room selected. Please select a room first.');
        setTimeout(() => window.location.href = 'rooms.html', 2000);
      }

      let selectedRoom = null;

      // Load room details
      async function loadRoomDetails() {
        try {
          // Get room from session storage or API
          const saved = sessionStorage.getItem('selectedRoom');
          if (saved) {
            selectedRoom = JSON.parse(saved);
            document.getElementById('roomType').textContent = selectedRoom.type;
            document.getElementById('roomPrice').textContent = '$' + selectedRoom.price;
          } else {
            // Fetch from API
            const rooms = await API.getRooms();
            selectedRoom = rooms.find(r => r.id == roomId);
            if (selectedRoom) {
              document.getElementById('roomType').textContent = selectedRoom.type;
              document.getElementById('roomPrice').textContent = '$' + selectedRoom.pricePerNight;
              selectedRoom.price = selectedRoom.pricePerNight; // Normalize property name
            }
          }
        } catch (error) {
          showError('bookingAlert', 'Failed to load room details');
        }
      }

      // Set minimum dates
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayStr = today.toISOString().split('T')[0];
      
      const checkinInput = document.getElementById('checkin');
      const checkoutInput = document.getElementById('checkout');
      
      checkinInput.min = todayStr;
      checkoutInput.min = todayStr;

      // Update checkout min date when checkin changes
      checkinInput.addEventListener('change', function() {
        const checkinDate = this.value;
        if (checkinDate) {
          // Set checkout minimum to day after checkin
          const nextDay = new Date(checkinDate);
          nextDay.setDate(nextDay.getDate() + 1);
          checkoutInput.min = nextDay.toISOString().split('T')[0];
          
          // Clear checkout if it's before new minimum
          if (checkoutInput.value && checkoutInput.value <= checkinDate) {
            checkoutInput.value = '';
            checkoutInput.classList.add('is-invalid');
            showError('bookingAlert', 'Please select a new check-out date (must be after check-in)');
          } else {
            checkoutInput.classList.remove('is-invalid');
          }
          
          // Enable and highlight checkout field
          checkoutInput.disabled = false;
          checkoutInput.classList.add('border-primary');
          
          // Recalculate if both dates are set
          calculateTotal();
        }
      });

      // Recalculate when checkout changes
      checkoutInput.addEventListener('change', function() {
        this.classList.remove('is-invalid', 'border-primary');
        calculateTotal();
      });

      // Disable checkout initially
      checkoutInput.disabled = true;
      checkoutInput.placeholder = 'Select check-in first';

      function calculateTotal() {
        const checkin = document.getElementById('checkin').value;
        const checkout = document.getElementById('checkout').value;

        if (checkin && checkout && selectedRoom) {
          const checkInDate = new Date(checkin);
          const checkOutDate = new Date(checkout);
          const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

          if (nights > 0) {
            const total = nights * (selectedRoom.price || selectedRoom.pricePerNight);
            document.getElementById('numNights').textContent = nights;
            document.getElementById('totalPrice').textContent = '$' + total;
          } else {
            document.getElementById('numNights').textContent = '-';
            document.getElementById('totalPrice').textContent = '-';
          }
        }
      }

      // Submit booking
      document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const checkin = document.getElementById('checkin').value;
        const checkout = document.getElementById('checkout').value;

        if (!checkin || !checkout) {
          showError('bookingAlert', 'Please select check-in and check-out dates');
          return;
        }

        const checkInDate = new Date(checkin);
        const checkOutDate = new Date(checkout);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Validate check-in is not in the past
        if (checkInDate < today) {
          showError('bookingAlert', 'Check-in date cannot be in the past');
          return;
        }
        
        // Validate checkout is after checkin
        if (checkOutDate <= checkInDate) {
          showError('bookingAlert', 'Check-out date must be at least one day after check-in date');
          return;
        }

        // Calculate nights
        const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
        if (nights < 1) {
          showError('bookingAlert', 'Minimum booking is 1 night');
          return;
        }

        const btn = document.getElementById('bookNowBtn');
        const btnText = btn.querySelector('.btn-text');
        const spinner = btn.querySelector('.spinner-border');

        try {
          btn.disabled = true;
          btnText.classList.add('d-none');
          spinner.classList.remove('d-none');

          // Step 1: Create booking with proper date format
          // Add time to dates to match API format
          const checkInDateTime = new Date(checkin + 'T12:00:00.000Z');
          const checkOutDateTime = new Date(checkout + 'T12:00:00.000Z');

          const bookingData = {
            roomId: parseInt(roomId),
            checkIn: checkInDateTime.toISOString(),
            checkOut: checkOutDateTime.toISOString()
          };

          console.log('Creating booking with data:', bookingData);
          const booking = await API.createBooking(bookingData);
          console.log('Booking created:', booking);

          if (!booking || !booking.id) {
            throw new Error('Failed to create booking');
          }

          // Step 2: Create payment intent
          const paymentData = {
            bookingId: booking.id,
            amount: booking.totalPrice,
            currency: 'usd',
            description: `Hotel Booking #${booking.id} - Room ${booking.roomNumber}`
          };

          console.log('Creating payment intent:', paymentData);
          const paymentIntent = await API.createPaymentIntent(paymentData);
          console.log('Payment intent created:', paymentIntent);

          if (!paymentIntent || !paymentIntent.paymentIntentId) {
            throw new Error('Failed to create payment intent');
          }

          // Step 3: Process payment (simulate card payment)
          console.log('Processing payment...');
          const paymentResult = await API.processCardPayment(paymentIntent.paymentIntentId);
          console.log('Payment result:', paymentResult);

          if (paymentResult.success) {
            // Step 4: Verify payment status
            const paymentStatus = await API.checkPaymentStatus(paymentIntent.paymentIntentId);
            console.log('Payment status:', paymentStatus);

            if (paymentStatus.success) {
              // Show success modal
              document.getElementById('bookingId').textContent = booking.id;
              const modal = new bootstrap.Modal(document.getElementById('bookingSuccessModal'));
              modal.show();

              // Clear session storage
              sessionStorage.removeItem('selectedRoom');

              // Redirect after 3 seconds
              setTimeout(() => {
                window.location.href = 'user-dashboard.html';
              }, 3000);
            } else {
              throw new Error(paymentStatus.message || 'Payment verification failed');
            }
          } else {
            throw new Error(paymentResult.message || 'Payment failed');
          }

        } catch (error) {
          console.error('Booking/Payment error:', error);
          
          // More detailed error message
          let errorMessage = 'Booking failed. Please try again.';
          
          if (error.message.includes('400')) {
            errorMessage = 'Invalid booking data. Please check your dates and try again.';
          } else if (error.message.includes('401') || error.message.includes('403')) {
            errorMessage = 'Authentication error. Please login again.';
          } else if (error.message) {
            errorMessage = error.message;
          }
          
          showError('bookingAlert', errorMessage);
        } finally {
          btn.disabled = false;
          btnText.classList.remove('d-none');
          spinner.classList.add('d-none');
        }
      });

      // Load room details on page load
      loadRoomDetails();
    </script>
  </body>
</html>